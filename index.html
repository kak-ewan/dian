<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAS UMUM</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="app" class="min-h-screen">
        <!-- Pre-Login Page -->
        <div id="pre-login" class="flex flex-col items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
                <div class="flex flex-col items-center">
                    <img id="logo" src="" alt="Logo Sekolah" class="h-24 w-auto mb-4">
                    <h2 class="mt-2 text-center text-3xl font-extrabold text-gray-900">KAS UMUM</h2>
                    <p id="description" class="mt-2 text-center text-sm text-gray-600"></p>
                </div>
                <div class="mt-8">
                    <div class="rounded-md shadow-sm">
                        <div>
                            <label for="username" class="sr-only">Username</label>
                            <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Username">
                        </div>
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>

                    <div class="mt-6">
                        <button onclick="login()" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Masuk
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard (Hidden until login) -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow">
                <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900">KAS UMUM</h1>
                    <button onclick="logout()" class="text-sm text-blue-600 hover:text-blue-800">Keluar</button>
                </div>
            </header>

            <!-- Main Content -->
            <main>
                <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <!-- Current Balance -->
                    <div class="px-4 py-6 sm:px-0">
                        <div class="border-4 border-dashed border-gray-200 rounded-lg p-8 text-center">
                            <h2 class="text-lg font-medium text-gray-500">SALDO SAAT INI</h2>
                            <p id="current-balance" class="mt-2 text-5xl font-semibold text-gray-900">Rp0</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="action-buttons" class="mt-5 flex justify-center space-x-4">
                        <button onclick="showTransactionForm('income')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i class="fas fa-plus mr-2"></i> Pemasukan
                        </button>
                        <button onclick="showTransactionForm('expense')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-minus mr-2"></i> Pengeluaran
                        </button>
                        <button onclick="showReport()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-file-alt mr-2"></i> Rekap
                        </button>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="mt-8">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">3 TRANSAKSI TERAKHIR</h3>
                        <div id="recent-transactions" class="mt-4 grid gap-5 grid-cols-1 sm:grid-cols-3">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Transaction Form Modal -->
        <div id="transaction-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                    <div>
                        <h3 id="transaction-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                        <div class="mt-5">
                            <form id="transaction-form" class="space-y-4">
                                <input type="hidden" id="transaction-type">
                                <div>
                                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Tanggal</label>
                                    <input type="date" id="transaction-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="transaction-description" class="block text-sm font-medium text-gray-700">Uraian</label>
                                    <input type="text" id="transaction-description" name="description" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div id="amount-field">
                                    <!-- Amount field will be dynamically set based on transaction type -->
                                </div>
                                <div>
                                    <label for="transaction-notes" class="block text-sm font-medium text-gray-700">Keterangan</label>
                                    <textarea id="transaction-notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                </div>
                                <div>
                                    <label for="transaction-receipt" class="block text-sm font-medium text-gray-700">Upload Foto Barang (Opsional)</label>
                                    <input type="file" id="transaction-receipt" name="receipt" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                        <button onclick="submitTransaction()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:col-start-2 sm:text-sm">
                            Simpan
                        </button>
                        <button onclick="hideTransactionForm()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Modal -->
        <div id="report-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6">
                    <div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">REKAP TRANSAKSI</h3>
                        <div class="mt-5">
                            <div class="flex justify-between mb-4">
                                <div>
                                    <label for="report-start-date" class="block text-sm font-medium text-gray-700">Dari Tanggal</label>
                                    <input type="date" id="report-start-date" class="mt-1 block border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="report-end-date" class="block text-sm font-medium text-gray-700">Sampai Tanggal</label>
                                    <input type="date" id="report-end-date" class="mt-1 block border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <button onclick="loadReport()" class="self-end inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-filter mr-2"></i> Filter
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uraian</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pemasukan</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengeluaran</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Report data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-6">
                        <button onclick="hideReport()" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                            Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div id="edit-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                    <div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Transaksi</h3>
                        <div class="mt-5">
                            <form id="edit-form" class="space-y-4">
                                <input type="hidden" id="edit-id">
                                <div>
                                    <label for="edit-date" class="block text-sm font-medium text-gray-700">Tanggal</label>
                                    <input type="date" id="edit-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="edit-description" class="block text-sm font-medium text-gray-700">Uraian</label>
                                    <input type="text" id="edit-description" name="description" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="edit-income" class="block text-sm font-medium text-gray-700">Pemasukan</label>
                                    <input type="number" id="edit-income" name="income" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="edit-expense" class="block text-sm font-medium text-gray-700">Pengeluaran</label>
                                    <input type="number" id="edit-expense" name="expense" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="edit-notes" class="block text-sm font-medium text-gray-700">Keterangan</label>
                                    <textarea id="edit-notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                </div>
                                <div id="edit-receipt-container">
                                    <!-- Receipt image will be shown here if exists -->
                                </div>
                                <div>
                                    <label for="edit-receipt" class="block text-sm font-medium text-gray-700">Ganti Foto Barang (Opsional)</label>
                                    <input type="file" id="edit-receipt" name="receipt" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                        <button onclick="updateTransaction()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:col-start-2 sm:text-sm">
                            Simpan Perubahan
                        </button>
                        <button onclick="hideEditForm()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let appData = {
            logo: '',
            description: '',
            users: [],
            transactions: [],
            currentBalance: 0
        };

        // Endpoint configuration
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxKy9CplLBPAZvLNgQ-A59G2bzj0xQ14dx9I4rFkMpqzNt1ow8cFr2QMobP9Q8NjiYWpA/exec';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for transaction date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            
            // Load initial data
            loadInitialData();
        });

        // Load initial data (logo, description, users)
        async function loadInitialData() {
            try {
                const response = await fetch(API_ENDPOINT + '?action=getInitialData');
                const data = await response.json();
                
                if (data.success) {
                    appData.logo = data.logo || '';
                    appData.description = data.description || '';
                    appData.users = data.users || [];
                    
                    // Update UI
                    if (appData.logo) {
                        document.getElementById('logo').src = appData.logo;
                    }
                    if (appData.description) {
                        document.getElementById('description').textContent = appData.description;
                    }
                } else {
                    alert('Gagal memuat data awal: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                alert('Terjadi kesalahan saat memuat data awal');
            }
        }

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Username dan password harus diisi');
                return;
            }
            
            // Check against local users data first
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                
                // Hide pre-login, show dashboard
                document.getElementById('pre-login').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Load transactions and balance
                await loadTransactions();
                updateUIForUserRole();
            } else {
                alert('Username atau password salah');
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Hide dashboard, show pre-login
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('pre-login').classList.remove('hidden');
        }

        // Update UI based on user role
        function updateUIForUserRole() {
            const actionButtons = document.getElementById('action-buttons');
            
            if (currentUser.role === 'Bendahara') {
                actionButtons.classList.remove('hidden');
            } else {
                actionButtons.classList.add('hidden');
            }
        }

        // Load transactions and update balance
        async function loadTransactions() {
            try {
                const response = await fetch(API_ENDPOINT + '?action=getTransactions');
                const data = await response.json();
                
                if (data.success) {
                    appData.transactions = data.transactions || [];
                    appData.currentBalance = data.currentBalance || 0;
                    
                    // Update UI
                    updateBalanceDisplay();
                    updateRecentTransactions();
                } else {
                    alert('Gagal memuat transaksi: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                alert('Terjadi kesalahan saat memuat transaksi');
            }
        }

        // Update balance display
        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('current-balance');
            balanceElement.textContent = formatCurrency(appData.currentBalance);
            
            // Change color based on balance
            if (appData.currentBalance > 0) {
                balanceElement.classList.remove('text-red-600', 'text-gray-900');
                balanceElement.classList.add('text-green-600');
            } else if (appData.currentBalance < 0) {
                balanceElement.classList.remove('text-green-600', 'text-gray-900');
                balanceElement.classList.add('text-red-600');
            } else {
                balanceElement.classList.remove('text-green-600', 'text-red-600');
                balanceElement.classList.add('text-gray-900');
            }
        }

        // Update recent transactions display
        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            container.innerHTML = '';
            
            // Get last 3 transactions
            const recentTransactions = [...appData.transactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);
            
            if (recentTransactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Belum ada transaksi</p>';
                return;
            }
            
            recentTransactions.forEach(transaction => {
                const transactionElement = document.createElement('div');
                transactionElement.className = 'bg-white overflow-hidden shadow rounded-lg';
                
                const isIncome = transaction.income > 0;
                const amount = isIncome ? transaction.income : transaction.expense;
                const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                
                transactionElement.innerHTML = `
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                <i class="fas ${isIncome ? 'fa-arrow-down' : 'fa-arrow-up'} text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    ${transaction.description}
                                </dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold ${amountClass}">
                                        ${isIncome ? '+' : '-'}${formatCurrency(amount)}
                                    </div>
                                    <div class="ml-2 text-sm font-medium text-gray-500">
                                        ${formatDate(transaction.date)}
                                    </div>
                                </dd>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">${transaction.notes || 'Tidak ada keterangan'}</p>
                        </div>
                    </div>
                `;
                
                container.appendChild(transactionElement);
            });
        }

        // Show transaction form
        function showTransactionForm(type) {
            document.getElementById('transaction-type').value = type;
            
            const title = document.getElementById('transaction-title');
            const amountField = document.getElementById('amount-field');
            
            if (type === 'income') {
                title.textContent = 'TAMBAH PEMASUKAN';
                amountField.innerHTML = `
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Jumlah Pemasukan</label>
                    <input type="number" id="transaction-amount" name="amount" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0">
                `;
            } else {
                title.textContent = 'TAMBAH PENGELUARAN';
                amountField.innerHTML = `
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Jumlah Pengeluaran</label>
                    <input type="number" id="transaction-amount" name="amount" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0">
                `;
            }
            
            document.getElementById('transaction-modal').classList.remove('hidden');
        }

        // Hide transaction form
        function hideTransactionForm() {
            document.getElementById('transaction-modal').classList.add('hidden');
            document.getElementById('transaction-form').reset();
        }

        // Submit transaction
        async function submitTransaction() {
            const form = document.getElementById('transaction-form');
            const formData = new FormData(form);
            const type = document.getElementById('transaction-type').value;
            const amount = document.getElementById('transaction-amount').value;
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('Jumlah harus lebih dari 0');
                return;
            }
            
            // Prepare data for API
            const transactionData = {
                action: 'addTransaction',
                date: formData.get('date'),
                description: formData.get('description'),
                income: type === 'income' ? parseFloat(amount) : 0,
                expense: type === 'expense' ? parseFloat(amount) : 0,
                notes: formData.get('notes'),
                role: currentUser.role
            };
            
            // Handle file upload if exists
            const receiptFile = document.getElementById('transaction-receipt').files[0];
            if (receiptFile) {
                transactionData.receipt = receiptFile;
            }
            
            try {
                // Create FormData for the request (to handle file upload)
                const apiFormData = new FormData();
                for (const key in transactionData) {
                    apiFormData.append(key, transactionData[key]);
                }
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: apiFormData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Transaksi berhasil disimpan');
                    hideTransactionForm();
                    await loadTransactions();
                } else {
                    alert('Gagal menyimpan transaksi: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting transaction:', error);
                alert('Terjadi kesalahan saat menyimpan transaksi');
            }
        }

        // Show report
        function showReport() {
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = today.toISOString().split('T')[0];
            
            document.getElementById('report-start-date').value = firstDay;
            document.getElementById('report-end-date').value = lastDay;
            
            document.getElementById('report-modal').classList.remove('hidden');
            loadReport();
        }

        // Hide report
        function hideReport() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        // Load report data
        async function loadReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Harap pilih rentang tanggal');
                return;
            }
            
            try {
                const response = await fetch(`${API_ENDPOINT}?action=getReport&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                
                if (data.success) {
                    const transactions = data.transactions || [];
                    const tableBody = document.getElementById('report-table-body');
                    tableBody.innerHTML = '';
                    
                    if (transactions.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Tidak ada transaksi dalam rentang tanggal ini</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(transaction.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${transaction.income > 0 ? formatCurrency(transaction.income) : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${transaction.expense > 0 ? formatCurrency(transaction.expense) : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.balance > 0 ? 'text-green-600' : transaction.balance < 0 ? 'text-red-600' : 'text-gray-900'}">${formatCurrency(transaction.balance)}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${transaction.notes || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${currentUser.role === 'Bendahara' ? `
                                <button onclick="showEditForm('${transaction.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                <button onclick="deleteTransaction('${transaction.id}')" class="text-red-600 hover:text-red-900">Hapus</button>
                                ` : '-'}
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    alert('Gagal memuat laporan: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading report:', error);
                alert('Terjadi kesalahan saat memuat laporan');
            }
        }

        // Show edit form
        async function showEditForm(transactionId) {
            try {
                const response = await fetch(`${API_ENDPOINT}?action=getTransaction&id=${transactionId}`);
                const data = await response.json();
                
                if (data.success && data.transaction) {
                    const transaction = data.transaction;
                    
                    // Fill the form
                    document.getElementById('edit-id').value = transaction.id;
                    document.getElementById('edit-date').value = transaction.date;
                    document.getElementById('edit-description').value = transaction.description;
                    document.getElementById('edit-income').value = transaction.income;
                    document.getElementById('edit-expense').value = transaction.expense;
                    document.getElementById('edit-notes').value = transaction.notes || '';
                    
                    // Show receipt if exists
                    const receiptContainer = document.getElementById('edit-receipt-container');
                    receiptContainer.innerHTML = '';
                    
                    if (transaction.receiptUrl) {
                        receiptContainer.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700">Foto Barang Saat Ini</label>
                            <img src="${transaction.receiptUrl}" alt="Foto Barang" class="mt-2 max-w-xs h-auto">
                        `;
                    }
                    
                    document.getElementById('edit-modal').classList.remove('hidden');
                } else {
                    alert('Gagal memuat data transaksi: ' + (data.message || 'Transaksi tidak ditemukan'));
                }
            } catch (error) {
                console.error('Error loading transaction for edit:', error);
                alert('Terjadi kesalahan saat memuat data transaksi');
            }
        }

        // Hide edit form
        function hideEditForm() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-form').reset();
            document.getElementById('edit-receipt-container').innerHTML = '';
        }

        // Update transaction
        async function updateTransaction() {
            const id = document.getElementById('edit-id').value;
            const date = document.getElementById('edit-date').value;
            const description = document.getElementById('edit-description').value;
            const income = parseFloat(document.getElementById('edit-income').value) || 0;
            const expense = parseFloat(document.getElementById('edit-expense').value) || 0;
            const notes = document.getElementById('edit-notes').value;
            
            if (!date || !description) {
                alert('Tanggal dan uraian harus diisi');
                return;
            }
            
            if (income < 0 || expense < 0) {
                alert('Jumlah pemasukan/pengeluaran tidak boleh negatif');
                return;
            }
            
            if (income > 0 && expense > 0) {
                alert('Transaksi tidak boleh memiliki pemasukan dan pengeluaran sekaligus');
                return;
            }
            
            const transactionData = {
                action: 'updateTransaction',
                id: id,
                date: date,
                description: description,
                income: income,
                expense: expense,
                notes: notes,
                role: currentUser.role
            };
            
            // Handle file upload if exists
            const receiptFile = document.getElementById('edit-receipt').files[0];
            if (receiptFile) {
                transactionData.receipt = receiptFile;
            }
            
            try {
                // Create FormData for the request (to handle file upload)
                const apiFormData = new FormData();
                for (const key in transactionData) {
                    apiFormData.append(key, transactionData[key]);
                }
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: apiFormData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Transaksi berhasil diperbarui');
                    hideEditForm();
                    await loadTransactions();
                    await loadReport(); // Refresh report if open
                } else {
                    alert('Gagal memperbarui transaksi: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating transaction:', error);
                alert('Terjadi kesalahan saat memperbarui transaksi');
            }
        }

        // Delete transaction
        async function deleteTransaction(transactionId) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                return;
            }
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=deleteTransaction&id=${transactionId}&role=${currentUser.role}`
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Transaksi berhasil dihapus');
                    await loadTransactions();
                    await loadReport(); // Refresh report if open
                } else {
                    alert('Gagal menghapus transaksi: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Terjadi kesalahan saat menghapus transaksi');
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            return 'Rp' + parseFloat(amount).toLocaleString('id-ID');
        }

        // Helper function to format date
        function formatDate(dateString) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }
    </script>
</body>
</html>
